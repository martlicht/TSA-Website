---
import { Image } from "astro:assets";
import SectionContainer from "../../ui/SectionContainer.astro";
import hero2Background from "../../../assets/images/awnings/hero2-bg.webp";
---

<section
  id="contact-form-section"
  class="relative w-full min-h-screen flex items-center justify-center overflow-hidden py-16 sm:py-20"
>
  <!-- Background Image -->
  <div class="absolute inset-0">
    <Image
      src={hero2Background}
      alt="Contact Background"
      class="w-full h-full object-cover"
      loading="lazy"
      quality={80}
      format="webp"
    />
  </div>

  <!-- Dark Overlay for better contrast -->
  <div
    class="absolute inset-0 bg-gradient-to-br from-black/70 via-black/60 to-black/70"
  >
  </div>

  <!-- Content -->
  <SectionContainer class="relative z-10">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12 items-center">
      <!-- Left: Headline -->
      <div class="text-white">
        <h2 class="contact-headline mb-6">
          Find out how<br />
          we can<br />
          transform<br />
          <span class="text-primary italic">your</span> space.
        </h2>
      </div>

      <!-- Right: Form Card -->
      <div
        class="contact-form-card bg-white/95 backdrop-blur-sm rounded-3xl p-8 sm:p-10 shadow-2xl"
      >
        <form id="contact-form" class="space-y-6">
          <!-- First Name & Last Name -->
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
             <div>
               <label for="firstName" class="form-label"> First name </label>
               <input
                 type="text"
                 id="firstName"
                 name="firstName"
                 placeholder="First name"
                 required
                 class="form-input"
               />
               <div id="firstName-error" class="field-error hidden"></div>
             </div>
             <div>
               <label for="lastName" class="form-label"> Last name </label>
               <input
                 type="text"
                 id="lastName"
                 name="lastName"
                 placeholder="Last name"
                 required
                 class="form-input"
               />
               <div id="lastName-error" class="field-error hidden"></div>
             </div>
          </div>

           <!-- Email -->
           <div>
             <label for="email" class="form-label"> Email </label>
             <input
               type="email"
               id="email"
               name="email"
               placeholder="you@company.com"
               required
               class="form-input"
             />
             <div id="email-error" class="field-error hidden"></div>
           </div>

           <!-- Phone Number -->
           <div>
             <label for="phone" class="form-label"> Phone number </label>
             <div class="phone-input-wrapper">
               <div class="country-code-selector">
                 <span class="country-code-display">+1</span>
               </div>
               <input
                 type="tel"
                 id="phone"
                 name="phone"
                 placeholder="(555) 000-0000"
                 required
                 class="form-input phone-input"
                 maxlength="17"
               />
             </div>
             <div id="phone-error" class="field-error hidden"></div>
           </div>

          <!-- Products Interest Checkboxes -->
          <div>
            <label class="form-label mb-3">What products are you interested in?</label>
            <div class="grid grid-cols-2 gap-3">
              <label class="checkbox-label">
                <input type="checkbox" name="products" value="Roll Up Awning" class="checkbox-input" />
                <span class="checkbox-text">Roll Up Awning</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="products" value="Instant Sukkah" class="checkbox-input" />
                <span class="checkbox-text">Instant Sukkah</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="products" value="Pergoloft" class="checkbox-input" />
                <span class="checkbox-text">Pergoloft</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="products" value="Plexi Awnings" class="checkbox-input" />
                <span class="checkbox-text">Plexi Awnings</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="products" value="Staircase Awnings" class="checkbox-input" />
                <span class="checkbox-text">Staircase Awnings</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="products" value="Pool Shades" class="checkbox-input" />
                <span class="checkbox-text">Pool Shades</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="products" value="Canopies" class="checkbox-input" />
                <span class="checkbox-text">Canopies</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="products" value="Vestibules" class="checkbox-input" />
                <span class="checkbox-text">Vestibules</span>
              </label>
              <label class="checkbox-label col-span-2">
                <input type="checkbox" name="products" value="Other" class="checkbox-input" />
                <span class="checkbox-text">Other</span>
              </label>
            </div>
          </div>

          <!-- Privacy Policy Checkbox -->
          <div class="flex items-start gap-3">
            <input
              type="checkbox"
              id="privacyPolicy"
              name="privacyPolicy"
              required
              class="mt-1 w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary focus:ring-2 cursor-pointer"
            />
            <label for="privacyPolicy" class="text-sm text-gray-600">
              You agree to our friendly <a href="/privacy-policy" class="text-primary underline hover:text-primary-dark">privacy policy</a>.
            </label>
          </div>

          <!-- Submit Button -->
          <button
            type="submit"
            class="w-full bg-primary text-white font-medium text-lg py-4 rounded-lg hover:bg-primary-dark transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
          >
            Send message
          </button>

          <!-- Success Message (hidden by default) -->
          <div
            id="success-message"
            class="hidden p-4 bg-green-50 border border-green-200 rounded-lg"
          >
            <p class="text-green-800 text-center font-medium">
              ✓ Message sent successfully! We'll get back to you soon.
            </p>
          </div>

           <!-- Error Message (hidden by default) -->
           <div
             id="error-message"
             class="hidden p-4 bg-red-50 border border-red-200 rounded-lg"
           >
             <p id="error-message-text" class="text-red-800 text-center font-medium">
               ✗ Something went wrong. Please try again.
             </p>
           </div>
        </form>
      </div>
    </div>
  </SectionContainer>
</section>

<style>
  /* Contact Headline */
  .contact-headline {
    font-family: "Inter", system-ui, sans-serif;
    font-weight: 700;
    font-size: 3rem;
    line-height: 110%;
    letter-spacing: -0.02em;
  }

  @media (min-width: 640px) {
    .contact-headline {
      font-size: 3.5rem;
    }
  }

  @media (min-width: 1024px) {
    .contact-headline {
      font-size: 4rem;
    }
  }

  /* Form Card */
  .contact-form-card {
    max-width: 500px;
    margin: 0 auto;
    width: 100%;
  }

  @media (min-width: 1024px) {
    .contact-form-card {
      margin: 0;
    }
  }

  /* Form Label */
  .form-label {
    display: block;
    font-family: "Inter", system-ui, sans-serif;
    font-weight: 500;
    font-size: 0.875rem;
    color: #6b7280;
    margin-bottom: 0.5rem;
  }

  /* Form Input */
  .form-input {
    width: 100%;
    padding: 0.875rem 1rem;
    font-size: 1rem;
    color: #111827;
    background-color: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    transition: all 0.2s;
    font-family: "Inter", system-ui, sans-serif;
  }

  .form-input:focus {
    outline: none;
    border-color: #68c28c;
    background-color: #ffffff;
    box-shadow: 0 0 0 3px rgba(104, 194, 140, 0.1);
  }

  .form-input::placeholder {
    color: #9ca3af;
  }

  /* Phone Input Wrapper */
  .phone-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    background-color: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    transition: all 0.2s;
  }

  .phone-input-wrapper:focus-within {
    border-color: #68c28c;
    background-color: #ffffff;
    box-shadow: 0 0 0 3px rgba(104, 194, 140, 0.1);
  }

  /* Country Code Selector */
  .country-code-selector {
    position: relative;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    padding: 0.875rem 1rem;
    border-right: 1px solid #e5e7eb;
  }

  .country-code-display {
    font-size: 1rem;
    color: #111827;
    font-family: "Inter", system-ui, sans-serif;
    font-weight: 500;
  }

  .phone-input-wrapper:focus-within .country-code-selector {
    border-right-color: #68c28c;
  }

  /* Phone Input */
  .phone-input {
    flex: 1;
    border: none;
    border-radius: 0 0.5rem 0.5rem 0;
    background-color: transparent;
    padding-left: 0.75rem;
  }

  .phone-input:focus {
    outline: none;
    box-shadow: none;
    background-color: transparent;
  }

   .phone-input-wrapper:focus-within .phone-input {
     background-color: transparent;
   }

   /* Field Error */
   .field-error {
     margin-top: 0.5rem;
     font-size: 0.875rem;
     color: #dc2626;
     font-family: "Inter", system-ui, sans-serif;
   }

   .field-error.hidden {
     display: none;
   }

   .form-input.error {
     border-color: #dc2626;
     background-color: #fef2f2;
   }

   /* Checkbox Label */
   .checkbox-label {
     display: flex;
     align-items: center;
     gap: 0.5rem;
     cursor: pointer;
     padding: 0.5rem;
     border-radius: 0.375rem;
     transition: background-color 0.2s;
   }

   .checkbox-label:hover {
     background-color: #f9fafb;
   }

   /* Checkbox Input */
   .checkbox-input {
     width: 1.125rem;
     height: 1.125rem;
     border: 2px solid #d1d5db;
     border-radius: 0.25rem;
     cursor: pointer;
     flex-shrink: 0;
     appearance: none;
     -webkit-appearance: none;
     -moz-appearance: none;
     background-color: #ffffff;
     position: relative;
     transition: all 0.2s ease;
   }

   .checkbox-input:hover {
     border-color: #68c28c;
   }

   .checkbox-input:checked {
     background-color: #68c28c;
     border-color: #68c28c;
   }

   .checkbox-input:checked::after {
     content: '';
     position: absolute;
     left: 0.25rem;
     top: 0.0625rem;
     width: 0.375rem;
     height: 0.625rem;
     border: solid white;
     border-width: 0 2px 2px 0;
     transform: rotate(45deg);
   }

   .checkbox-input:focus {
     outline: none;
     box-shadow: 0 0 0 3px rgba(104, 194, 140, 0.2);
     border-color: #68c28c;
   }

   /* Checkbox Text */
   .checkbox-text {
     font-family: "Inter", system-ui, sans-serif;
     font-size: 0.875rem;
     color: #374151;
     user-select: none;
   }

   /* Checkbox Selected Animation */
   .checkbox-selected {
     animation: checkboxHighlight 2s ease-out;
   }

   @keyframes checkboxHighlight {
     0% {
       background-color: rgba(104, 194, 140, 0.3);
     }
     100% {
       background-color: transparent;
     }
   }
 </style>

<script>
  // Phone Number Formatting
  function formatPhoneNumber(value: string, countryCode: string): string {
    // Remove all non-digit characters
    const digits = value.replace(/\D/g, "");

    // Format based on country code
    if (countryCode === "+1") {
      // US/Canada format: (555) 000-0000
      if (digits.length <= 3) {
        return digits;
      } else if (digits.length <= 6) {
        return `(${digits.slice(0, 3)}) ${digits.slice(3)}`;
      } else {
        return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6, 10)}`;
      }
    } else if (countryCode === "+44") {
      // UK format: 020 0000 0000
      if (digits.length <= 3) {
        return digits;
      } else if (digits.length <= 7) {
        return `${digits.slice(0, 3)} ${digits.slice(3)}`;
      } else {
        return `${digits.slice(0, 3)} ${digits.slice(3, 7)} ${digits.slice(7, 11)}`;
      }
    } else {
      // Default: just add spaces every 3-4 digits
      return digits.replace(/(\d{3})(\d{3})(\d+)/, "$1 $2 $3").trim();
    }
  }

  function initPhoneInput() {
    const phoneInput = document.getElementById("phone") as HTMLInputElement;
    if (!phoneInput) return;

    // Format phone number as user types (US/Canada format)
    phoneInput.addEventListener("input", (e) => {
      const target = e.target as HTMLInputElement;
      const digits = target.value.replace(/\D/g, "");
      const formatted = formatPhoneNumber(digits, "+1");
      target.value = formatted;
    });

    // Prevent non-digit characters (except formatting)
    phoneInput.addEventListener("keypress", (e) => {
      const char = String.fromCharCode(e.which || e.keyCode);
      if (!/[0-9]/.test(char) && e.which !== 8 && e.which !== 0) {
        e.preventDefault();
      }
    });
  }

   // Helper function to show field errors
   function showFieldError(fieldName: string, message: string) {
     const errorElement = document.getElementById(`${fieldName}-error`);
     const inputElement = document.getElementById(fieldName) as HTMLInputElement;
     
     if (errorElement) {
       errorElement.textContent = message;
       errorElement.classList.remove("hidden");
     }
     
     if (inputElement) {
       inputElement.classList.add("error");
     }
   }

   // Helper function to clear all field errors
   function clearFieldErrors() {
     const errorElements = document.querySelectorAll(".field-error");
     const inputElements = document.querySelectorAll(".form-input");
     
     errorElements.forEach((el) => {
       el.classList.add("hidden");
       el.textContent = "";
     });
     
     inputElements.forEach((el) => {
       el.classList.remove("error");
     });
   }

   // Map backend field names to form field IDs
   const fieldNameMap: Record<string, string> = {
     first_name: "firstName",
     last_name: "lastName",
     email: "email",
     phone_number: "phone",
   };

   // Contact Form Handler
   function initContactForm() {
     const form = document.getElementById("contact-form") as HTMLFormElement;
     const successMessage = document.getElementById("success-message");
     const errorMessage = document.getElementById("error-message");
     const errorMessageText = document.getElementById("error-message-text");

     if (!form) return;

     // Initialize phone input
     initPhoneInput();

     // Clear field errors when user starts typing
     const formInputs = form.querySelectorAll("input");
     formInputs.forEach((input) => {
       input.addEventListener("input", () => {
         const fieldName = input.id;
         const errorElement = document.getElementById(`${fieldName}-error`);
         if (errorElement) {
           errorElement.classList.add("hidden");
           errorElement.textContent = "";
         }
         input.classList.remove("error");
       });
     });

     form.addEventListener("submit", async (e) => {
       e.preventDefault();

       // Hide previous messages and clear field errors
       successMessage?.classList.add("hidden");
       errorMessage?.classList.add("hidden");
       clearFieldErrors();

      // Validate phone number
      const phoneInput = document.getElementById("phone") as HTMLInputElement;
      const phoneDigits = phoneInput?.value.replace(/\D/g, "") || "";
      const countryCode = "+1"; // Always US/Canada

      // Minimum phone number length validation (7 digits minimum for flexibility)
      if (phoneDigits.length < 7) {
        showFieldError("phone", "Please enter a valid phone number (at least 7 digits)");
        phoneInput?.focus();
        return;
      }

      // Get form data
      const formData = new FormData(form);

      // Get selected products
      const selectedProducts = Array.from(formData.getAll("products")) as string[];
      const productsString = selectedProducts.length > 0 ? selectedProducts.join(", ") : "";

      // Prepare data for backend API (matching Postman snippet exactly)
      // Send phone number without country code (e.g., "4540122222")
      const raw = JSON.stringify({
        first_name: formData.get("firstName") as string,
        last_name: formData.get("lastName") as string,
        email: formData.get("email") as string,
        phone_number: phoneDigits,
        phone_country_code: "US",
        source: "tristateawnings.com",
        products_interest: productsString,
      });

      try {
        // Get environment variables (Astro exposes PUBLIC_* vars in client-side code)
        const apiUrl = import.meta.env.PUBLIC_API_URL;
        const apiKey = import.meta.env.PUBLIC_API_KEY;

        if (!apiUrl || !apiKey) {
          throw new Error("API configuration is missing");
        }

        const myHeaders = new Headers();
        myHeaders.append("Content-Type", "application/json");
        myHeaders.append("APIkey", apiKey);

        const requestOptions: RequestInit = {
          method: "POST",
          headers: myHeaders,
          body: raw,
          redirect: "follow",
        };

         const response = await fetch(apiUrl, requestOptions);
         const responseText = await response.text();

         if (!response.ok) {
           // Try to parse error response
           let errorData: any = null;
           try {
             errorData = JSON.parse(responseText);
           } catch (parseError) {
             // If parsing fails, use the raw text
             console.error("API Error (raw):", responseText);
             throw new Error(`Failed to send message: ${response.status}`);
           }

           console.error("API Error:", errorData);

           // Handle structured error response
           if (errorData.errors && typeof errorData.errors === "object") {
             // Show field-specific errors
             Object.keys(errorData.errors).forEach((backendFieldName) => {
               const formFieldName = fieldNameMap[backendFieldName] || backendFieldName;
               const fieldErrors = errorData.errors[backendFieldName];
               
               if (Array.isArray(fieldErrors) && fieldErrors.length > 0) {
                 // Show the first error for each field
                 showFieldError(formFieldName, fieldErrors[0]);
               }
             });
           }

           // Show general error message
           const generalMessage = errorData.message || "Something went wrong. Please check the form and try again.";
           if (errorMessageText) {
             errorMessageText.textContent = `✗ ${generalMessage}`;
           }
           errorMessage?.classList.remove("hidden");

           // Don't hide error message automatically - let user fix errors
           return;
         }

         const result = JSON.parse(responseText);
         console.log("Success:", result);

         // Show success message
         successMessage?.classList.remove("hidden");

         // Reset form
         form.reset();
         clearFieldErrors();

         // Hide success message after 5 seconds
         setTimeout(() => {
           successMessage?.classList.add("hidden");
         }, 5000);
       } catch (error) {
         console.error("Error submitting form:", error);

         // Show generic error message
         if (errorMessageText) {
           errorMessageText.textContent = "✗ Something went wrong. Please try again.";
         }
         errorMessage?.classList.remove("hidden");

         // Hide error message after 5 seconds
         setTimeout(() => {
           errorMessage?.classList.add("hidden");
         }, 5000);
       }
    });
  }

  // Initialize on page load
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initContactForm);
  } else {
    initContactForm();
  }

  // Re-initialize after Astro page transitions
  document.addEventListener("astro:page-load", initContactForm);
</script>
