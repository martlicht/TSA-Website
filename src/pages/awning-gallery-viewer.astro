---
import Layout from '../layouts/Layout.astro';
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';

// Cargar todas las imágenes
const imageModules = import.meta.glob<{ default: ImageMetadata }>('../assets/images/awnings/*.{webp,png,jpg,jpeg}', {
	eager: true
});

const galleryImages = Object.entries(imageModules)
	.map(([path, module]) => {
		const image = module.default;
		return {
			src: image,
			alt: `Roll-up awning installation - ${path.split('/').pop()?.replace(/\.(webp|png|jpg|jpeg)$/i, '') || 'Gallery image'}`,
			width: image.width,
			height: image.height,
		};
	})
	.filter(img => img.src);

// Obtener el índice de la imagen desde la URL
const url = Astro.url;
const imageIndex = parseInt(url.searchParams.get('index') || '0');
const currentImageIndex = Math.max(0, Math.min(imageIndex, galleryImages.length - 1));
---

<Layout title="Awning Gallery">
	<!-- Cinema Mode Gallery Viewer -->
	<div class="cinema-container" id="gallery-viewer">
		<!-- Close Button -->
		<a 
			href="/awnings#gallery-section"
			class="close-button"
			aria-label="Close gallery"
		>
			<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
			</svg>
		</a>

		<!-- Navigation Buttons -->
		<button 
			class="nav-button nav-button-prev"
			aria-label="Previous image"
			id="prev-btn"
			style={currentImageIndex === 0 ? 'opacity: 0.3; pointer-events: none;' : ''}
		>
			<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
			</svg>
		</button>

		<button 
			class="nav-button nav-button-next"
			aria-label="Next image"
			id="next-btn"
			style={currentImageIndex === galleryImages.length - 1 ? 'opacity: 0.3; pointer-events: none;' : ''}
		>
			<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
			</svg>
		</button>

		<!-- Gallery Wrapper -->
		<div class="gallery-wrapper" transition:name={`gallery-image-${currentImageIndex}`}>
			<!-- Image Container -->
			<div class="image-container">
				<div class="image-slider" id="image-slider" style={`transform: translateX(-${currentImageIndex * 100}%);`}>
					{galleryImages.map((image, index) => (
						<div class="image-slide" data-index={index}>
							<Image 
								src={image.src}
								alt={image.alt}
								width={image.width}
								height={image.height}
								class="gallery-image"
								loading="eager"
								quality={90}
								format="webp"
							/>
						</div>
					))}
				</div>
			</div>

			<!-- Gallery Info -->
			<div class="gallery-info">
				<div class="gallery-counter">
					<span class="current-index">{currentImageIndex + 1}</span>
					<span class="separator">/</span>
					<span class="total-count">{galleryImages.length}</span>
				</div>

				<!-- Thumbnail Preview Slider -->
				<div class="thumbnail-container">
					<div class="thumbnail-slider" id="thumbnail-slider">
						{galleryImages.map((image, index) => (
							<button
								class={`thumbnail-item ${index === currentImageIndex ? 'active' : ''}`}
								data-index={index}
								aria-label={`View image ${index + 1}`}
							>
								<Image
									src={image.src}
									alt={image.alt}
									width={120}
									height={80}
									class="thumbnail-image"
									loading="lazy"
									quality={60}
									format="webp"
								/>
								<div class="thumbnail-overlay"></div>
							</button>
						))}
					</div>
				</div>
			</div>
		</div>

		<!-- Background Overlay -->
		<div class="cinema-overlay"></div>
	</div>
</Layout>

<script>
	const galleryImages = Array.from(document.querySelectorAll('.image-slide'));
	const totalImages = galleryImages.length;
	let currentIndex = parseInt(document.getElementById('image-slider')?.style.transform.match(/-?\d+/)?.[0] || '0') / -100;
	
	const slider = document.getElementById('image-slider') as HTMLElement;
	const thumbnailSlider = document.getElementById('thumbnail-slider') as HTMLElement;
	const prevBtn = document.getElementById('prev-btn') as HTMLElement;
	const nextBtn = document.getElementById('next-btn') as HTMLElement;
	const currentIndexSpan = document.querySelector('.current-index') as HTMLElement;
	const thumbnailItems = document.querySelectorAll('.thumbnail-item') as NodeListOf<HTMLElement>;

	function updateSlider() {
		if (!slider) return;
		
		slider.style.transform = `translateX(-${currentIndex * 100}%)`;
		
		// Update counter
		if (currentIndexSpan) {
			currentIndexSpan.textContent = String(currentIndex + 1);
		}

		// Update navigation buttons
		if (prevBtn) {
			prevBtn.style.opacity = currentIndex === 0 ? '0.3' : '1';
			prevBtn.style.pointerEvents = currentIndex === 0 ? 'none' : 'auto';
		}

		if (nextBtn) {
			nextBtn.style.opacity = currentIndex === totalImages - 1 ? '0.3' : '1';
			nextBtn.style.pointerEvents = currentIndex === totalImages - 1 ? 'none' : 'auto';
		}

		// Update thumbnails
		thumbnailItems.forEach((thumb, index) => {
			if (index === currentIndex) {
				thumb.classList.add('active');
				// Scroll thumbnail into view
				thumb.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
			} else {
				thumb.classList.remove('active');
			}
		});

		// Update URL without reload
		const newUrl = new URL(window.location.href);
		newUrl.searchParams.set('index', String(currentIndex));
		window.history.replaceState({}, '', newUrl.toString());
	}

	function goToImage(index) {
		currentIndex = Math.max(0, Math.min(index, totalImages - 1));
		updateSlider();
	}

	function nextImage() {
		if (currentIndex < totalImages - 1) {
			goToImage(currentIndex + 1);
		}
	}

	function prevImage() {
		if (currentIndex > 0) {
			goToImage(currentIndex - 1);
		}
	}

	// Event listeners
	if (prevBtn) {
		prevBtn.addEventListener('click', prevImage);
	}

	if (nextBtn) {
		nextBtn.addEventListener('click', nextImage);
	}

	// Thumbnail click handlers
	thumbnailItems.forEach((thumb, index) => {
		thumb.addEventListener('click', () => {
			goToImage(index);
		});
	});

	// Keyboard navigation
	document.addEventListener('keydown', (e) => {
		if (e.key === 'Escape') {
			window.location.href = '/awnings#gallery-section';
		} else if (e.key === 'ArrowLeft') {
			prevImage();
		} else if (e.key === 'ArrowRight') {
			nextImage();
		}
	});

	// Touch/swipe support
	let touchStartX = 0;
	let touchEndX = 0;

	const container = document.getElementById('gallery-viewer');
	if (container) {
		container.addEventListener('touchstart', (e) => {
			touchStartX = e.touches[0].clientX;
		});

		container.addEventListener('touchend', (e) => {
			touchEndX = e.changedTouches[0].clientX;
			handleSwipe();
		});
	}

	function handleSwipe() {
		const swipeThreshold = 50;
		const diff = touchStartX - touchEndX;

		if (Math.abs(diff) > swipeThreshold) {
			if (diff > 0) {
				nextImage(); // Swipe left = next
			} else {
				prevImage(); // Swipe right = prev
			}
		}
	}

	// Initialize
	updateSlider();
</script>

<style>
	/* Cinema Container - Full Screen */
	.cinema-container {
		position: fixed;
		inset: 0;
		background: #000;
		display: flex;
		align-items: center;
		justify-content: center;
		z-index: 9999;
		overflow-y: auto;
		overflow-x: hidden;
		padding: 2rem 0;
	}

	/* Animated Background Overlay */
	.cinema-overlay {
		position: absolute;
		inset: 0;
		background: radial-gradient(
			circle at center,
			rgba(104, 194, 140, 0.1) 0%,
			rgba(0, 0, 0, 0.95) 70%
		);
		animation: pulseGlow 8s ease-in-out infinite;
		pointer-events: none;
		z-index: 1;
	}

	@keyframes pulseGlow {
		0%, 100% {
			opacity: 0.3;
			transform: scale(1);
		}
		50% {
			opacity: 0.6;
			transform: scale(1.05);
		}
	}

	/* Close Button */
	.close-button {
		position: absolute;
		top: 2rem;
		right: 2rem;
		z-index: 100;
		color: white;
		background: rgba(255, 255, 255, 0.1);
		backdrop-filter: blur(10px);
		border-radius: 50%;
		width: 56px;
		height: 56px;
		display: flex;
		align-items: center;
		justify-content: center;
		transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
		border: 2px solid rgba(255, 255, 255, 0.2);
		cursor: pointer;
	}

	.close-button:hover {
		background: rgba(104, 194, 140, 0.3);
		border-color: rgba(104, 194, 140, 0.5);
		transform: rotate(90deg) scale(1.1);
	}

	/* Navigation Buttons */
	.nav-button {
		position: absolute;
		top: 50%;
		transform: translateY(-50%);
		z-index: 100;
		color: white;
		background: rgba(255, 255, 255, 0.1);
		backdrop-filter: blur(10px);
		border-radius: 50%;
		width: 56px;
		height: 56px;
		display: flex;
		align-items: center;
		justify-content: center;
		transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
		border: 2px solid rgba(255, 255, 255, 0.2);
		cursor: pointer;
	}

	.nav-button:hover:not(:disabled) {
		background: rgba(104, 194, 140, 0.3);
		border-color: rgba(104, 194, 140, 0.5);
		transform: translateY(-50%) scale(1.1);
	}

	.nav-button-prev {
		left: 2rem;
	}

	.nav-button-next {
		right: 2rem;
	}

	/* Gallery Wrapper */
	.gallery-wrapper {
		position: relative;
		z-index: 10;
		width: 90%;
		max-width: 1400px;
		margin: 0 auto;
		animation: fadeInScale 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
		display: flex;
		flex-direction: column;
		align-items: center;
	}

	@keyframes fadeInScale {
		from {
			opacity: 0;
			transform: scale(0.95);
		}
		to {
			opacity: 1;
			transform: scale(1);
		}
	}

	/* Image Container */
	.image-container {
		position: relative;
		width: 100%;
		aspect-ratio: 16 / 9;
		border-radius: 24px;
		overflow: hidden;
		box-shadow: 
			0 0 0 1px rgba(104, 194, 140, 0.2),
			0 20px 60px rgba(0, 0, 0, 0.8),
			0 0 80px rgba(104, 194, 140, 0.15);
		background: #000;
	}

	/* Image Slider */
	.image-slider {
		display: flex;
		width: 100%;
		height: 100%;
		transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
		will-change: transform;
	}

	.image-slide {
		flex: 0 0 100%;
		width: 100%;
		height: 100%;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.gallery-image {
		width: 100%;
		height: 100%;
		object-fit: contain;
	}

	/* Gallery Info */
	.gallery-info {
		margin-top: 2rem;
		text-align: center;
		color: white;
		animation: fadeInUp 1s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.3s backwards;
		width: 100%;
		max-width: 1000px;
	}

	@keyframes fadeInUp {
		from {
			opacity: 0;
			transform: translateY(20px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	.gallery-counter {
		font-family: 'Inter', system-ui, sans-serif;
		font-weight: 600;
		font-size: 1.25rem;
		text-shadow: 0 2px 12px rgba(0, 0, 0, 0.8);
		color: rgba(255, 255, 255, 0.95);
	}

	.current-index {
		color: rgba(104, 194, 140, 1);
	}

	.separator {
		margin: 0 0.5rem;
		opacity: 0.5;
	}

	/* Thumbnail Preview Slider */
	.thumbnail-container {
		margin-top: 1.5rem;
		width: 100%;
		overflow-x: auto;
		overflow-y: hidden;
		padding: 0.5rem 0;
		scrollbar-width: thin;
		scrollbar-color: rgba(104, 194, 140, 0.5) transparent;
	}

	.thumbnail-container::-webkit-scrollbar {
		height: 6px;
	}

	.thumbnail-container::-webkit-scrollbar-track {
		background: rgba(255, 255, 255, 0.1);
		border-radius: 3px;
	}

	.thumbnail-container::-webkit-scrollbar-thumb {
		background: rgba(104, 194, 140, 0.5);
		border-radius: 3px;
	}

	.thumbnail-container::-webkit-scrollbar-thumb:hover {
		background: rgba(104, 194, 140, 0.7);
	}

	.thumbnail-slider {
		display: flex;
		gap: 0.75rem;
		justify-content: center;
		align-items: center;
		padding: 0.5rem;
		min-width: fit-content;
	}

	.thumbnail-item {
		flex-shrink: 0;
		position: relative;
		width: 80px;
		height: 60px;
		border-radius: 8px;
		overflow: hidden;
		cursor: pointer;
		border: 2px solid transparent;
		background: transparent;
		padding: 0;
		transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
		opacity: 0.6;
	}

	.thumbnail-item:hover {
		opacity: 0.9;
		transform: scale(1.1);
		border-color: rgba(255, 255, 255, 0.3);
	}

	.thumbnail-item.active {
		opacity: 1;
		border-color: rgba(104, 194, 140, 0.8);
		box-shadow: 
			0 0 0 2px rgba(104, 194, 140, 0.3),
			0 4px 12px rgba(104, 194, 140, 0.4);
		transform: scale(1.15);
	}

	.thumbnail-image {
		width: 100%;
		height: 100%;
		object-fit: cover;
		display: block;
	}

	.thumbnail-overlay {
		position: absolute;
		inset: 0;
		background: linear-gradient(to bottom, transparent 0%, rgba(0, 0, 0, 0.3) 100%);
		pointer-events: none;
		transition: opacity 0.3s;
	}

	.thumbnail-item.active .thumbnail-overlay {
		opacity: 0;
	}

	/* Responsive Adjustments */
	@media (max-width: 768px) {
		.gallery-wrapper {
			width: 95%;
		}

		.close-button,
		.nav-button {
			width: 48px;
			height: 48px;
		}

		.nav-button-prev {
			left: 1rem;
		}

		.nav-button-next {
			right: 1rem;
		}

		.close-button {
			top: 1rem;
			right: 1rem;
		}

		.image-container {
			border-radius: 16px;
		}

		.gallery-counter {
			font-size: 1rem;
		}

		.thumbnail-item {
			width: 60px;
			height: 45px;
		}

		.thumbnail-slider {
			gap: 0.5rem;
		}
	}
</style>

